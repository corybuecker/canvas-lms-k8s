FROM ruby:2.4-alpine AS builder
LABEL version="2019-07-13"

ENV RAILS_ENV "production"
ENV COMPILE_ASSETS_NPM_INSTALL 0
ENV APP_DIR="/app"

RUN apk add git vim yarn python \
    alpine-sdk bash postgresql-dev \
    sqlite-dev xmlsec-dev

RUN mkdir -p ${APP_DIR}
WORKDIR ${APP_DIR}

RUN git clone https://github.com/instructure/canvas-lms.git .
RUN git checkout stable

RUN gem install bundler --version 1.13.6
RUN yarn install

RUN cp config/delayed_jobs.yml.example config/delayed_jobs.yml
RUN mkdir -p log tmp/pids public/assets app/stylesheets/brandable_css_brands && \
    touch app/stylesheets/_brandable_variables_defaults_autogenerated.scss && \
    touch Gemfile.lock && touch log/production.log

RUN echo "gem 'tzinfo-data'" >> Gemfile
RUN bundle install
RUN CANVAS_BUILD_CONCURRENCY=1 bundle exec rake canvas:compile_assets

ADD database.yml ${APP_DIR}/config/database.yml
ADD security.yml ${APP_DIR}/config/security.yml
ADD dynamic_settings.yml ${APP_DIR}/config/dynamic_settings.yml
ADD domain.yml ${APP_DIR}/config/domain.yml
ADD redis.yml ${APP_DIR}/config/redis.yml
ADD cache_store.yml ${APP_DIR}/config/cache_store.yml
ADD public_file_server.rb ${APP_DIR}/config/initializers/public_file_server.rb
RUN rm -rf node_modules .git

FROM ruby:2.4-alpine
RUN apk add vim postgresql-dev sqlite-dev xmlsec-dev
COPY --from=builder /app /app
COPY --from=builder /usr/local/bundle /usr/local/bundle
COPY --from=builder /usr/local/lib/ruby/gems/2.4.0 /usr/local/lib/ruby/gems/2.4.0

ENV RAILS_ENV "production"
WORKDIR /app

CMD ["bundle", "exec", "puma", "-p", "3000", "-w", "1", "-e", "production"]
